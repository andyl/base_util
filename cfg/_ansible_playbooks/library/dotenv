#!/usr/bin/env bash
#
# All of these contortions are done to use the .rbenv
# ruby instead of the system ruby.

export FILEARG=$1

/usr/bin/env ruby <<-EOF

file    = ENV["FILEARG"]
dotfile = if File.exist?(file)
            File.read(file).split('=').last
          else
            abort("Needs dotfile (absolute path)")
          end

abort("Dotfile not found (#{dotfile})") unless File.exist?(dotfile)

require 'json'

env = {}

File.readlines(dotfile).each do |line|
  next unless line.include?("=")
  key, val = line.split('=')
  env[key.strip] = val.chomp.strip
end

puts JSON.dump({"ansible_facts" => env})

EOF
